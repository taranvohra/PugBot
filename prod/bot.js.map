{"version":3,"sources":["../src/bot.js"],"names":["dotenv","config","cachedDB","PugList","eventEmitter","events","EventEmitter","disabledEvents","bot","Client","on","console","log","message","author","equals","user","content","startsWith","prefix","Servers","serversObj","Pugs","Channel","id","username","args","substring","length","split","action","toLowerCase","roles","member","commands","setchannel","includes","servers","addqueryserver","delqueryserver","queryut99server","addgametype","delgametype","joingametype","leavegametype","listgametype","channelId","channel","result","status","updateCache","cache","send","msg","catch","error","filledPugs","reduce","acc","pug","discriminator","revisePugList","list","parseInt","noPlayers","push","forBroadcast","map","forEach","ap","deadPugs","API","getCopyOfDB","login","process","env","DISCORD_BOT_TOKEN","toUpdate","newCache","pugEvents","captainsReady"],"mappings":"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","file":"bot.js","sourcesContent":["import { Client } from 'discord.js';\nimport events from 'events';\nimport dotenv from 'dotenv';\nimport { prefix, commands, pugEvents } from './constants';\nimport {\n  addQueryServer,\n  queryUT99Server,\n  delQueryServer,\n  setPreferredChannel,\n} from './ut99query';\nimport {\n  addGameType,\n  delGameType,\n  joinGameType,\n  leaveGameType,\n  listAvailablePugs,\n} from './pug';\nimport {\n  printServerStatus,\n  printServerList,\n  printPugJoinStatus,\n  printPugLeaveStatus,\n  printPugStatuses,\n  broadCastFilledPugs,\n  broadCastDeadPugs,\n} from './formats';\nimport { checkIfRoleIsPrivileged, fixSpecialCharactersInName } from './helpers';\nimport { createSortedArrayFromObject } from './util';\nimport API from './api';\n\ndotenv.config();\n\n/**\n * PugList is list of pugs active at any moment on the server\n * Pugs are the pug(s)/gametype(s) registered on the server with their props\n */\n\nlet cachedDB = {};\nlet PugList = {};\n\nconst eventEmitter = new events.EventEmitter();\nconst disabledEvents = ['TYPING_START', 'CHANNEL_UPDATE', 'USER_UPDATE'];\nconst bot = new Client({ disabledEvents });\n\nbot.on('ready', () => {\n  console.log('ready');\n});\n\nbot.on('message', async message => {\n  if (message.author.equals(bot.user)) return;\n  if (!message.content.startsWith(prefix)) return;\n\n  const { Servers: serversObj = {}, Pugs = {}, Channel = '' } = cachedDB;\n  const user = {\n    id: message.author.id,\n    username: fixSpecialCharactersInName(message.author.username),\n  };\n\n  const args = message.content.substring(prefix.length).split(' ');\n  const action = args[0].toLowerCase();\n  const roles = message.member.roles;\n\n  switch (true) {\n    case checkIfRoleIsPrivileged(roles) &&\n      commands.setchannel.includes(action): {\n      const channelId = message.channel.id;\n      const result = await setPreferredChannel(channelId);\n      result.status ? updateCache('Servers', result.cache) : '';\n      message.channel.send(result.msg);\n      break;\n    }\n\n    case commands.servers.includes(action): {\n      const Servers = createSortedArrayFromObject(serversObj, 'timestamp');\n      message.channel\n        .send(printServerList(Servers))\n        .catch(console.error + ':list:');\n      break;\n    }\n\n    case checkIfRoleIsPrivileged(roles) &&\n      commands.addqueryserver.includes(action): {\n      const Servers = createSortedArrayFromObject(serversObj);\n      const result = await addQueryServer(args, Servers);\n      result.status ? updateCache('Servers', result.cache) : '';\n      message.channel.send(result.msg);\n      break;\n    }\n\n    case checkIfRoleIsPrivileged(roles) &&\n      commands.delqueryserver.includes(action): {\n      const Servers = createSortedArrayFromObject(serversObj);\n      const result = await delQueryServer(args, Servers);\n      result.status ? updateCache('Servers', result.cache) : '';\n      message.channel.send(result.msg);\n      break;\n    }\n\n    case commands.queryut99server.includes(action): {\n      const Servers = createSortedArrayFromObject(serversObj, 'timestamp');\n      const result = await queryUT99Server(args[1], Servers);\n      message.channel\n        .send(result.status ? printServerStatus(result) : result.msg)\n        .catch(console.error + ':query:');\n      break;\n    }\n\n    case commands.addgametype.includes(action): {\n      const result = await addGameType(args, Pugs);\n      result.status ? updateCache('Pugs', result.cache) : '';\n      message.channel.send(result.msg);\n      break;\n    }\n\n    case commands.delgametype.includes(action): {\n      const result = await delGameType(args, Pugs);\n      result.status ? updateCache('Pugs', result.cache) : '';\n      message.channel.send(result.msg);\n      break;\n    }\n\n    case commands.joingametype.includes(action): {\n      const { status, result, msg } = joinGameType(args, user, Pugs, PugList);\n      const filledPugs = result.reduce((acc, { pug, discriminator }) => {\n        if (pug) {\n          revisePugList(discriminator, pug, 'update');\n          pug.list.length === parseInt(pug.noPlayers) ? acc.push(pug) : null;\n        }\n        return acc;\n      }, []);\n      message.channel\n        .send(status ? printPugJoinStatus(result) : msg)\n        .catch(console.error + ':join:');\n\n      const forBroadcast = filledPugs.map(pug => {\n        if (pug.list.length === pug.noPlayers) {\n          Object.values(PugList).forEach(ap => {\n            if (pug.discriminator !== ap.discriminator)\n              pug.list.forEach(user => {\n                const { result } = leaveGameType(\n                  ['l', ap.discriminator],\n                  user,\n                  Pugs,\n                  PugList\n                );\n                if (result[0].pug) {\n                  revisePugList(\n                    ap.discriminator,\n                    result[0].pug,\n                    result[0].pug.list.length === 0 ? 'remove' : 'update'\n                  );\n                  message.channel.send(printPugLeaveStatus(result));\n                }\n              });\n          });\n          return pug;\n        }\n      });\n      forBroadcast.length > 0\n        ? message.channel.send(broadCastFilledPugs(forBroadcast))\n        : null;\n      break;\n    }\n\n    case commands.leavegametype.includes(action): {\n      const { status, result, msg } = leaveGameType(args, user, Pugs, PugList);\n      const deadPugs = result.reduce((acc, { pug, discriminator }) => {\n        if (pug) {\n          revisePugList(\n            discriminator,\n            pug,\n            pug.list.length === 0 ? 'remove' : 'update'\n          );\n          pug.list.length === parseInt(pug.noPlayers) - 1\n            ? acc.push({ ...pug, user })\n            : null;\n        }\n        return acc;\n      }, []);\n      message.channel\n        .send(status ? printPugLeaveStatus(result) : msg)\n        .catch(console.error + ':leave:');\n      deadPugs.length > 0\n        ? message.channel.send(broadCastDeadPugs(deadPugs))\n        : null;\n      break;\n    }\n\n    case commands.listgametype.includes(action): {\n      const { status, result, msg } = listAvailablePugs(args, PugList);\n      message.channel\n        .send(status ? printPugStatuses(result) : msg)\n        .catch(console.error + ':list:');\n      break;\n    }\n    default:\n      console.log('no match');\n  }\n});\n\n(async () => {\n  cachedDB = await API.getCopyOfDB(`/`);\n  bot.login(process.env.DISCORD_BOT_TOKEN);\n})();\n\nconst updateCache = (toUpdate, newCache) => (cachedDB[toUpdate] = newCache);\n\nconst revisePugList = (discriminator, pug, action) => {\n  if (action === 'update') PugList[discriminator] = pug;\n  else if (action === 'remove' && PugList[discriminator])\n    delete PugList[discriminator];\n};\n\n/*\n  Events emitted for pugs\n*/\n\neventEmitter.on(pugEvents.captainsReady, discriminator => {});\n"]}